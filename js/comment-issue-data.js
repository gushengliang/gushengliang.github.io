var clientId,clientSecret,reqCommentCountUrl,valine,repoIssuesUrl="https://api.github.com/repos/userName/userRepo/issues",COMMENT_CACHE_KEY="commentKey",ADMIN_NAME="removeif";function ajaxReqForGitHub(e,t,n){$.ajax({type:"get",url:e,headers:{Accept:"application/json; charset=utf-8",Authorization:""+t},data:"",contentType:"application/json",dataType:"json",error:function(){console.log("req error")},success:function(e){n(e)}})}function writeHtmlCommentCountValueById(e,t,n){ajaxReqForGitHub((reqCommentCountUrl=t+"?t="+(new Date).getTime()+"&labels=Gitalk,")+e,n,(function(t){try{t.length>0&&$("#"+e).html(t[0].comments)}catch(e){console.error(e)}}))}function writeHtmlValineCommentCountValueById(e,t){t.Q(e).count().then((function(t){$("#"+md5(e)).html(t)}))}function fillComments(e,t){var n=[],a=e.length-1;$.each(e,(function(e,r){var l=r.body.trim(),o=!0;let i=(l=(l=l.replace(" ","")).replace("&nbsp;","")).indexOf(">")>-1,s=l.split("\n\n");if(2!=s.length){let e="\r\n\r\n";s=l.split(e)}if(2==s.length&&i)l=s[1];else if(s.length>2&&i)l=l.substr(l.indexOf("\n\n")+4);else for(l=l.replace(/(-)+>/g," to ");o;)if(-1!=l.lastIndexOf(">")){var c=l.substr(l.lastIndexOf(">")+1);null==c||""==c?(o=!0,l=l.substr(0,l.lastIndexOf(">")-1)):(o=!1,l=c)}else o=!1;l=dealWtihContentStr(l),ajaxReqForGitHub(r.issue_url,t,(function(t){addCommentInfo(t,n,r,a,e,l)}))}))}function dealWtihContentStr(e){return null!=e&&""!=e||(e="内容为空！"),(e=(e=e.replace(/![\s\w\](?:http(s)?:\/\/)+[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\*\+,;=.]+\)/g,"[图片]")).replace(/(?:http(s)?:\/\/)+[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\*\+,;=.]+/g,"[网址]")).length>28&&(e=e.substr(0,28),e+="..."),e}function addCommentInfo(e,t,n,a,r,l){var o=e.body.substr(0,e.body.indexOf("\n")-1);let i=n.user.login;null!=i&&""!=i&&i==ADMIN_NAME&&(i+="[博主]"),t.push({content:l,date:n.created_at,userName:i,userUrl:n.user.html_url,userAvatar:n.user.avatar_url,url:o}),a==r&&dealWithResultArr(t)}function dealWithResultArr(e){renderCommentData(e=e.sort((function(e,t){return t.date.localeCompare(e.date)})));var t={};t.date=(new Date).getTime(),t.data=e,e.length>6&&localStorage.setItem(COMMENT_CACHE_KEY,JSON.stringify(t))}function loadCommentDataAndRender(e){ajaxReqForGitHub(repoIssuesUrl+"/comments?sort=created&direction=desc&per_page=7&page=1",e,(function(t){fillComments(t,e)}))}function renderCommentData(e){if(e.length>0){for(var t="<div class='comment-content'>",n=0;n<e.length;n++){var a=e[n],r=a.content;t+="<div class='card-comment-item'><a href=\""+a.userUrl+"\"target=\"_blank\"><img class='ava' src='"+a.userAvatar+"'  onerror='this.onerror = null;this.src=\"https://cdn.jsdelivr.net/npm/gitalk@1/src/assets/icon/github.svg\";' /></a><div class='item-header-text'><a href='"+a.userUrl+"' target='_blank'>"+a.userName+"</a>&nbsp;发表于"+getDateDiff(new Date(a.date).getTime())+'</div><div class="item-text"><a href ="'+a.url+'#comment-container">'+r+"</a></div></div>"}t+="</div>",$(".body_hot_comment").html(t),loadPjax()}else $(".body_hot_comment").html("无数据记录！")}function loadIndexHotData(e){var t="",n="";if($("#index_hot_div").length>0){var a=$("#index_hot_div");ajaxReqForGitHub(repoIssuesUrl+"?per_page=10&sort=comments",e,(function(e){$.each(e,(function(e,a){t=e>=0&e<4?'class="item level3"':e>=4&e<7?'class="item level2"':e>=7&e<9?'class="item level1"':'class="item level0"',n+='<a href ="'+a.body.substr(0,a.body.indexOf("\n")-1)+'" '+t+">"+a.title.substr(0,a.title.indexOf("-")-1)+"&nbsp;🔥"+101*a.comments+"</a>&nbsp;&nbsp;"})),a.html(""),""==n?a.append("无数据记录！"):(a.append(n),loadPjax())}))}}function renderValineComment(e,t){$(".body_hot_comment").length>0&&e.Q("*").limit(8).find().then((function(e){for(var n=[],a=0;a<e.length;a++){var r=e[a]._serverData.nick;r==t&&(r+="[博主]");var l=e[a]._serverData.comment,o=e[a]._serverData.url,i=e[a]._serverData.insertedAt,s=e[a]._serverData.link,c=e[a]._serverData.mail;l=dealWtihContentStr(l=l.replace(/<\/?.+?>/g,""));var m="https://gravatar.loli.net/avatar/"+md5(c)+"?d=mp";c.endsWith("@qq.com")&&(m="https://q2.qlogo.cn/headimg_dl?dst_uin="+c.replace("@qq.com","")+"&spec=100"),n.push({content:l,date:new Date(i.getTime()-288e5).Format("yyyy-MM-ddThh:mm:ssZ"),userName:r,userUrl:s,userAvatar:m,url:o})}dealWithResultArr(n)}))}function loadIssueData(e,t,n,a,r){setTimeout((function(){var l,o={},s=localStorage.getItem(COMMENT_CACHE_KEY),c={};if(""!=s||null!=s)try{o=(c=JSON.parse(s)).data}catch(e){s=""}r?"function"==typeof Valine&&(ADMIN_NAME=n,null!=valine&&null!=valine||(valine=new Valine({el:"#comment-container-no",notify:!1,verify:!1,appId:e,appKey:t,placeholder:"留下您的高见！",avatar:"mp",avatarForce:!1,meta:["nick","mail","link"],pageSize:10,visitor:!1,highlight:!0,recordIP:!1}))):(repoIssuesUrl=repoIssuesUrl.replace("userName",n).replace("userRepo",a),ADMIN_NAME=n,l="Basic "+btoa((clientId=e)+":"+(clientSecret=t))),""==s||null==s||(new Date).getTime()-c.date>6e4?r?renderValineComment(valine,ADMIN_NAME):loadCommentDataAndRender(l):(console.log("load cache data..."),renderCommentData(o)),loadIndexHotData(l);var m=document.getElementsByClassName("display-none-class");if(null!=m&&m.length>0)for(i=0;i<m.length;i++){var u=m[i].innerText;r?writeHtmlValineCommentCountValueById(u,valine):writeHtmlCommentCountValueById(u,repoIssuesUrl,l)}console.log("~~~~欢迎光临！记得有时间多来看看哦，https://removeif.github.io/ ~~~~")}),500)}function loadPjax(){"function"==typeof Pjax&&(new Pjax({elements:"a",selectors:[".section","title"],cache:!0,cacheBust:!1}),document.addEventListener("pjax:complete",(function(){})))}